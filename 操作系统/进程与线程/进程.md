# 进程

## 进程的概念
- 当一个程序被运行，接着CPU会从磁盘加载这个程序的指令到内存，这时候就开启了一个进程，它是动态的，所以说进程就是程序的一次执行过程。
- 进程是一个程序及其数据在处理机上顺序执行时所发生的活动
- 进程是具有独立功能的程序在数据集合上运行的过程
- 进程也是分配资源的基本单位。
- 进程由程序段、数据段、PCB(程序控制块)三部分组成了进程实体。所谓的创建进程，实质上是创建进程实体中的PCB，而撤销进程，实质上是撤销进程实PCB

## 进程的状态
- 运行状态：该时刻进程占用 CPU；
- 就绪状态：可运行，但因为其他进程正在运行而暂停停止；
- 阻塞状态：该进程正在等待某一事件发生（如等待输入/输出操作的完成）而暂时停止运行，这时，即使给它CPU控制权，它也无法运行；
- 创建状态：进程正在被创建时的状态；
- 结束状态：进程正在从系统中消失时的状态；

![](https://files.mdnice.com/user/8332/3962c8e5-f43c-4442-92e4-557092088703.png)

### 状态变迁
- 创建状态-就绪态：进程刚刚创建，但没有获取到CPU时间片
- 就绪态到运行态：CPU分给这个进程时间片，正式运行该进程
- 运行态到就绪状态：时间片用完，回到就绪态
- 运行态到阻塞态：当进程请求某个事件必须等待，例如请求I/O事件
- 运行态到结束态：进程已经运行完成或者出错，会被操作系统结束状态处理
- 阻塞态到就绪态：当进程要等待的事件完成时，从阻塞状态变到就绪状态


### 挂起状态
表示进程没有占用内存空间

**挂起状态分为两种：**
- 阻塞挂起状态：进程在外存(硬盘)并等待某个事件的出现
- 就绪挂起状态：进程在外存(硬盘)，但只要进入内存，即刻立即运行
## 进程的控制结构
在操作系统中，使用进程控制块数据（process control block，PCB）结构来描述进程的，PCB是进程存在的唯一标识。

### PCB包含的信息
#### 进程描述信息
- 进程描述信息：
  - 进程标识符：标识各个进程，每个进程都有一个并且唯一的标识符；
  -  用户标识符：进程归属的用户，用户标识符主要为共享和保护服务；
- 进程控制和管理信息：
  - 进程当前状态，如 new、ready、running、waiting 或 blocked 等；
  - 进程优先级：进程抢占 CPU 时的优先级；
- 资源分配清单：有关内存地址空间或虚拟地址空间的信息，所打开文件的列表和所使用的 I/O 设备信息。
- CPU 相关信息：CPU 中各个寄存器的值，当进程被切换时，CPU 的状态信息都会被保存在相应的 PCB 中，以便进程重新执行时，能从断点处继续执行。

### PCB组织
- 通过链表方式：相同状态的进程链在一起，组成各种队列
  - 阻塞队列
  - 就绪队列
- 通过索引方式：将相同状态的进程组织在一个索引表中，索引表项指向相应的PCB，不同状态对应不同的索引表
## 进程的控制
- 创建进程：操作系统允许一个进程创建另一个进程，而且允许子进程继承父进程所拥有的资源，当子进程被终止时，其在父进程处继承的资源应当还给父进程。同时，终止父进程时同时也会终止其所有的子进程。
  - 为新进程分配一个唯一的进程标识号，并申请一个空白的PCB,PCB是有限的，若申请失败则创建失败。
  - 为进程分配资源，如果资源不足，进程会进入等待状态，以等待资源
  - 初始化PCB
  - 如果进程的调度队列能够接纳新进程，那么将进程插入到就绪队列，等待被调度运行
  
- 唤醒进程
  - 进程由「运行」转变为「阻塞」状态是由于进程必须等待某一事件的完成，所以处于阻塞状态的进程是绝对不可能叫醒自己的。
  - 如果某进程正在等待 I/O 事件，需由别的进程发消息给它，则只有当该进程所期待的事件出现时，才由发现者进程用唤醒语句叫醒它。
  - 唤醒过程：
    - 在该事件的阻塞队列中找到相应进程的PCB
    - 将其从阻塞队列中移出，并置其状态为就绪状态
    - 把该PCB插入到就绪队列中，等待调度程序调度
    
- 阻塞进程：当进程需要等待某一事件完成时，它可以调用阻塞语句把自己阻塞等待，而一旦被阻塞等待，它只能由另一个进程唤醒。
  - 阻塞过程：
    - 找到将要被阻塞进程标识号对应的PCB
    - 如果该进程为运行状态，则保护其现场，将其状态转为阻塞状态，停止运行
    - 将该PCB插入到阻塞队列中去
- 终止进程：进程可以有3种终止方式：正常结束，异常结束以及外界干预(信号被kill掉)
  - 终止进程过程：
    - 查找要终止的进程的PCB
    - 如果处于执行状态，则立即终止该进程的执行，然后将CPU资源分配给其他进程
    - 如果该进程有子进程，则将其他所有子进程终止
    - 回收该进程所有资源给予父进程或者操作系统
    - 将其从PCB所在队列中删除
    
## 进程的上下文切换
各个进程之间是共享 CPU 资源的，在不同的时候进程之间需要切换，让不同的进程可以在 CPU 执行，那么这个一个进程切换到另一个进程运行，称为进程的上下文切换。

### CPU上下文切换
CPU上下文切换包含：进程上下文切换、线程上下文切换和中断上下文切换

大多数操作系统都是多任务的，通常支持大于CPU数量的任务同时执行。实际上，这些任务并不是同时运行的，只是因为系统在很短的时间内，让各个任务分别在 CPU 运行，于是就造成同时运行的错误。

任务是交给CPU运行的，在每个任务执行前，CPU需要知道这些任务从哪里加载，又从哪里开始运行。所以操作系统会先帮CPU设置好CPU寄存器和程序计数器。

**CPU寄存器**：CPU内部的一块容量小，速度极快的内存。

**程序计数器**：存储CPU正在执行的指令位置、或者即将执行的下一条指令位置。

CPU 寄存器和程序计数是 CPU 在运行任何任务前，所必须依赖的环境，这些环境就叫做 CPU 上下文。

CPU 上下文切换就是先把前一个任务的 CPU 上下文（CPU 寄存器和程序计数器）保存起来，然后加载新任务的上下文到这些寄存器和程序计数器，最后再跳转到程序计数器所指的新位置，运行新任务。

**系统内核**会**存储**保存下来的**上下文信息**，当此任务再次被分配给 CPU 运行时，CPU 会重新加载这些上下文，这样就能保证任务原来的状态不受影响，让任务看起来还是连续运行。

#### 进程的上下文切换
进程是由内核管理和调度的，所以进程的切换只能发生在内核态，所以，进程的上下文切换不仅包含了虚拟内存，栈，全局变量等用户空间的资源，还包括了内核堆栈、寄存器等内核空间的资源

通常，会把交换的信息保存在进程的 PCB，当要运行另外一个进程的时候，我们需要从这个进程的 PCB 取出上下文，然后恢复到 CPU 中，这使得这个进程可以继续执行，如下图所示：

![](https://files.mdnice.com/user/8332/a0f9441f-3b7a-4764-b16b-7a7cf6831eb4.png)


## 进程的组织
- 通过链表方式：相同状态的进程链在一起，组成各种队列
  - 阻塞队列
  - 就绪队列
- 通过索引方式：将相同状态的进程组织在一个索引表中，索引表项指向相应的PCB，不同状态对应不同的索引表
## 进程的特征
- 动态性
- 并发性
- 独立性
- 异步性
- 结构性