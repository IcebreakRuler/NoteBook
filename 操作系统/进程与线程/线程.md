# 线程
在早期的从操作系统中都是以进程为独立运行的基本单位，直到后面，计算机科学家们又提出了更小的能独立运行的基本单位，也就是线程。

## 为什么使用线程？
多进程的这种方式，会出现的问题？
- 进程之间如何通信，共享数据？
- 维护进程的系统开销较大，如创建进程时，分配资源、建立 PCB；终止进程时，回收资源、撤销 PCB；进程切换时，保存当前进程的状态信息；

> 那到底如何解决呢？需要有一种新的实体，满足以下特性：
- 实体之间可以并发运行；
- 实体之间共享相同的地址空间；

这个新的实体就是线程，线程之间可以并发运行其共享相同的地址空间


## 什么是线程？
线程是进程中的一条执行流程

同一个进程内多个线程之间可以共享代码段、数据段、打开的文件等资源，**但每个线程都有独立一套的寄存器和栈**，这样就可以确保线程的控制流程是相对独立的。
![](https://files.mdnice.com/user/8332/e2baea7a-3a63-47a5-a193-faba06cd9f7d.png)

### 线程的优点？
- 一个进程中可以同时存在多个线程
- 各个线程之间可以并发执行
- 各个线程之间可以共享地址空间和文件等资源

### 线程的缺点？
- 当进程中的一个线程崩溃时，会导致所属进程的所有线程崩溃

## 线程的上下文切换
所谓的操作系统的任务调度，实际上的调度对象是线程，而进程只是给线程提供了虚拟内存、全局变量等资源
- 当进程只有一个线程时，可以认为进程就等于线程
- 当进程拥有多个线程时，这些线程会共享相同的虚拟内存和全局变量等资源，这些资源在上下文切换时时不需要修改的。

另外，线程也有自己的私有数据，比如栈和寄存器等，这些在上下文切换时也是需要保存的。
> 线程上下文的切换？
- 当两个线程不是同一个进程时，此时的切换跟进程的上下文切换一样。
- 当两个线程同属于一个进程时，，因为虚拟内存是共享的，所以在切换时，虚拟内存这些资源就保持不动，只需要切换线程的私有数据、寄存器等不共享的数据；

所以，线程的上下文切换相比进程，开销要小得多。

## 线程的实现？
- 用户线程（User Thread）：在**用户空间**实现的线程，不是由内核管理的线程，是由用户态的线程库来完成线程的管理；
- 内核线程（Kernel Thread）：在内核中实现的线程，是由内核管理的线程；
- 轻量级进程（LightWeight Process）：在内核中来支持用户线程；

### 什么是用户线程？ 如何理解？存在什么优势和缺陷？
用户线程基于用户态的线程管理库来实现的，那么线程控制款TCB,也是在库里面是实现的，对于操作系统而言是看不到这个TCB的，它只能看到整个进程的PCB。

所以，用户线程的整个线程管理和调度，操作系统是不直接参与的，而是由用户级线程库函数来完成线程的管理，包括线程的创建、终止、同步和调度等。
![](https://files.mdnice.com/user/8332/67b84b64-9f69-451d-b4c7-b350c266624e.png)

### 用户线程的优点？
- 用户的线程切换是由线程库函数来完成的，无需用户态与内核态的切换，所以速度特别快
- 每个进程都需要有它私有的线程控制块TCB列表，用来跟踪记录它各个线程状态信息(PC,栈指针，寄存器)，TCB由用户级线程库函数来维护。
- 可用于不支持线程的技术的操作系统。
### 用户线程的缺点？
- 由于操作系统不参与线程的调度，如果一个线程发起了系统调用而阻塞，那进程所包含的用户线程都不能执行了。
- 当一个线程开始运行后，除非它主动地交出 CPU 的使用权，否则它所在的进程当中的其他线程无法运行，因为用户态的线程没法打断当前运行中的线程，它没有这个特权，只有操作系统才有，但是用户线程不是由操作系统管理的。
- 由于时间片分配给进程，故与其他进程比，在多线程执行时，每个线程得到的时间片较少，执行会比较慢；


